$(function(){addViewHistory($("#productId").val());initProductImg();initProductSuit();initShippingFeeSelect();initProductSkuSelector();initSuitSkuSelector();initNumberInput();initDescTabs();initBtns();showLikes();initComments()});function initComments(){$(".rate_toolbar a").click(function(){var c=$(this);c.addClass("curr").siblings().removeClass("curr");var b=c.data("type");a(b,1)}).eq(0).trigger("click");function a(c,d){var b=$("#productId").val();$.get(ctx+"/product/comment?productId="+b+"&type="+c+"&p="+d,function(f){var e=$(".comment_list");e.html(f);initPageBar($(".page",e),function(g){a(c,g)});initVoteComment(e);initCommentImg(e)})}}function initCommentImg(a){$("a.show_img",a).on("click",function(g){_event.stop_bubble(g);$(this).addClass("curr").siblings().removeClass("curr");var d=$(this).closest(".pic");var c=$(this).find("img").attr("data-src");var f=d.find(".big_pic");if(f.size()>0){f.find("img").attr("src",c)}else{$(".big_pic").remove();f=$('<div class="big_pic"></div>');var b=document.createElement("img");b.src=c;d.append(f);f.append(b).slideDown().on("click",function(h){_event.stop_bubble(h)})}});a.on("click",".big_pic",function(b){_event.stop_bubble(b)});$(document).click(function(){$(".big_pic").remove()})}function initVoteComment(a){$("a.favor").on("click",function(){var c=$(this);if(!c.hasClass("curr")){if(isLogin()){var b=c.data("commentId");var d=c.data("value");$.post(ctx+"/user/comment/vote",{commentId:b,voteValue:d},function(e){if(e.code==1){c.addClass("curr").find("span").text(e.result)}else{if(e.code==0){loginBox()}else{showErrorAlert(e.message)}}},"json")}else{loginBox();return false}}})}function initBtns(){$(".btn_buy, .btn_addCart, .btn_presale_buy").click(function(){var d=$("#isSkuProduct").val()==="true";var c=$("#productId").val();if(d){var b=$("#skuId").val();if(!b||parseInt(b)<=0){showErrorAlert("请选择商品颜色类型！");return false}c=c+"_"+b}var e=parseInt($("#buyNumber").val());if(e<=0){showErrorAlert("请输入购买数量！");return false}var a=parseInt($("#buyNumber").attr("stock"));if(e>a){showErrorAlert("商品库存不足！");return false}if($(this).hasClass("btn_buy")){preCheckout(c,e)}else{if($(this).hasClass("btn_addCart")){addToCart(c,e)}else{if($(this).hasClass("btn_presale_buy")){preSaleCheckout(c,e)}}}return false})}function initDescTabs(){initTabs($(".desc_tab > li"),$(".desc_pane > div"),"curr",false,function(){})}function initShippingFeeSelect(){var i=$.cookie("shipping_dist");if(!i){i=110000}var d=$(".meta .shippingTo");var b=$(".meta .shippingPopup");d.click(function(){$(this).toggleClass("on");b.css({top:$(this).offset().top+$(this).outerHeight(),left:$(this).offset().left}).stop().slideToggle();return false});$(".close",b).on("click",function(){b.hide();d.removeClass("on")});initTabs($(".nav li",b),$(".pane dl",b),"curr",true,function(m){m.removeData().html("请选择<span></span>")});var c=$(".nav li:eq(0)",b);var f=$(".nav li:eq(1)",b);var j=$(".nav li:eq(2)",b);var k=$(".pane dl:eq(0)",b);var l=$(".pane dl:eq(1)",b);var g=$(".pane dl:eq(2)",b);k.delegate("dd","click",function(){c.data("areaId",$(this).data("areaId")).html($(this).text()+"<span></span>");e(f,l,$(this).data("areaId"));f.show().click();j.hide();return false});l.delegate("dd","click",function(){f.data("areaId",$(this).data("areaId")).html($(this).text()+"<span></span>");e(j,g,$(this).data("areaId"));j.show().click();return false});g.delegate("dd","click",function(){var m=$(this).data("areaId");j.data("areaId",m).html($(this).text()+"<span></span>");a(c.text()+"-"+f.text()+"-"+j.text());$.cookie("shipping_dist",m,{expires:365,path:"/"});$(".close",b).trigger("click");getYunFee(c.data("areaId"),f.data("areaId"),j.data("areaId"));return false});$($.fn.AddressSelect.getChild(1)).each(function(){k.append('<dd data-area-id="'+this.id+'">'+this.name+"</dd>")});var h=$.fn.AddressSelect.getFullAddress(i);if(h.length>0){c.data("areaId",h[0].id).html(h[0].name+"<span></span>");a(c.text());f.show().click();e(f,l,h[0].id);if(h.length==1){getYunFee(h[0].id,0,0)}}if(h.length>1){f.data("areaId",h[1].id).html(h[1].name+"<span></span>");a(c.text()+"-"+f.text());j.show().click();e(j,g,h[1].id);if(h.length==2){getYunFee(h[0].id,h[1].id,0)}}if(h.length>2){j.data("areaId",h[2].id).html(h[2].name+"<span></span>");a(c.text()+"-"+f.text()+"-"+j.text());if(h.length==3){getYunFee(h[0].id,h[1].id,h[2].id)}}function e(n,m,o){n.removeData().html("请选择<span></span>");m.empty();$($.fn.AddressSelect.getChild(o)).each(function(){m.append('<dd data-area-id="'+this.id+'" title="'+this.name+'">'+this.name+"</dd>")})}function a(m){d.html(m+"<i></i>").attr("title",m)}}function getYunFee(d,e,c){var b=$("#productId").val();var a=$("#buyNumber").val();$.post(ctx+"/buy/getShippingFee2",{productId:b,productNum:a,provinceId:d,cityId:e,districtId:c,deliveryType:0},function(f){if(f.code==1){$(".meta .shippingFee").text("￥"+formatMoney(f.result/100,2))}},"json")}function initProductImg(){$(".picFocus").slide({mainCell:".bd ul",effect:"left",trigger:"click",autoPlay:true}).find(".bd li").show();$(".picFocus .hd li").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})}function initProductSkuSelector(){var b=$("#productId").val();var a=$("#skuId").val();$.getJSON(ctx+"/product/skuList?productId="+b+"&_="+new Date().getTime(),function(c){if(c.code==1){$("#product_sku_table").sku({selectedClass:"curr",disabledClass:"null",skuMap:c.result,stockKey:"stocksNumber",default_sku:a,skuChanged:function(d){onSelectSku(d)},skuFound:function(d){onSelectSku(d)},skuLost:function(){$("#skuId").val("")}})}else{showErrorAlert(c.message)}})}function onSelectSku(b){var a="¥ "+getRmbPrice(b.shopPrice);if(b.shopPrice<b.marketPrice){a+="<s>原价¥ "+getRmbPrice(b.marketPrice)+"</s>"}$("#productShowPrice").html(a);$("#skuId").val(b.id);$("#stock_num").text(b.stocksNumber);$("#sold_num").text(b.salesNumber);$("#buyNumber").attr("stock",b.stocksNumber)}function initProductSuit(){$(".scom").slide({titCell:"ul li",mainCell:".content",trigger:"click",interTime:5000,effect:"left"}).find(".content>dl").show()}function initSuitSkuSelector(){$(".sku-selector").click(function(){var c=$(this);var a=$(this).data("pid");var d=$(this).data("suitId");var b=$("#sku-box-"+d+"-"+a);if(b.length>0){b.slideToggle()}else{$.getJSON(ctx+"/product/productSku?productId="+a+"&_="+new Date().getTime(),function(e){if(e.code==1){b=$(_.template($.trim($("#sku_tpl").html()))(e.result));b.attr("id","sku-box-"+d+"-"+a);$("body").append(b);var f={};$(e.result.skuList).each(function(){f[this.sku]=this});b.sku({selectedClass:"curr",disabledClass:"null",skuMap:f,stockKey:"stocksNumber"});b.find(".cancel").click(function(){b.slideUp();return false});b.find(".confirm").click(function(){var h=b.data("currentSku");if(h!=null){c.find("span").attr("title",h.skuStr).html(h.skuStr);var g=c.prev();g.val(a+"_"+h.id);b.slideUp()}return false});b.css({top:c.offset().top-10,left:c.offset().left-10}).slideDown()}else{showErrorAlert(e.message)}})}return false})}function addSuitToCart(c){try{var b=[];$('input[name="suit_pids_'+c+'"]').each(function(){var d=$(this).val();if(!d){throw"请您选择商品的颜色型号"}b.push(d)});$.ajax({type:"post",traditional:true,url:ctx+"/cart/addNum",data:{pids:"s"+c+"_"+b.join("-"),counts:1},success:function(d){if(d.code==1){syncCartNum();showAddToCartMsg()}else{showErrorAlert(d.message)}},dataType:"json"})}catch(a){showErrorAlert(a)}}function initNumberInput(){$(".number-input").numberInput({callback:function(b,a){var c=parseInt(b.data("stock"));if(a>c){b.addClass("ex-stock")}else{b.removeClass("ex-stock")}}})}function showLikes(){loadViewHistory(10,function(a){$(".guess_like dl").append(_.template($.trim($("#like_tpl").html()))({list:a}));initEllipsis($(".guess_like dl"))},$("#productId").val())};