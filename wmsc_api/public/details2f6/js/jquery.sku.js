/*!
 * jQuery Sku Plugin v0.1.0
 *
 * Copyright 2015
 *
 * @author Pangxin
 * @mail   pangxin001@163.com
 *
 * $('.sku').sku({
 *     skuMap: skuMap
 * });
 *
 */
(function(b){b.fn.sku=function(k){var l=b.extend({},b.fn.sku.defaults,k);l.skuMap=a(l.skuMap);l.serializedSkuMap=c(l.skuMap,l.stockKey);l.keys=j(l.skuMap);l.length=h(l.skuMap);return this.each(function(){var p=b(this);var r=0;var n={};var m=p.find(l.skuItem);m.each(function(){var s=b(this);var t=s.attr(l.attrName).split(":")[0];if(!(t in n)){n[t]=null}s.click(function(){var y=b(this);if(y.hasClass(l.disabledClass)){return}var A=y.attr(l.attrName).split(":")[0];if(!y.hasClass(l.selectedClass)){n[A]=y}else{n[A]=null}y.toggleClass(l.selectedClass).siblings().removeClass(l.selectedClass);var w=d(n),x=w.length,v=[];if(!x){m.each(function(){l.serializedSkuMap[b(this).attr(l.attrName)]?b(this).removeClass(l.disabledClass):b(this).addClass(l.disabledClass).removeClass(l.selectedClass)})}else{b(w).each(function(){v.push(b(this).attr(l.attrName))});v=g(v);var u=v.length;m.each(function(){var F=b(this);if(b.inArray(F[0],w)>-1||F[0]===y[0]){return}var C=F.siblings("."+l.selectedClass),B=[];if(C.length){var E=C.attr(l.attrName);for(var D=0;D<u;D++){(v[D]!=E)&&B.push(v[D])}}else{B=v.concat()}B=B.concat(F.attr(l.attrName));B=g(B);if(!l.serializedSkuMap[B.join(";")]){F.addClass(l.disabledClass).removeClass(l.selectedClass)}else{F.removeClass(l.disabledClass)}})}var x=v.length;if(x===l.length){var z=l.skuMap[v.join(";")];if(r===l.length){if(typeof l.skuChanged=="function"){l.skuChanged(z)}}else{if(typeof l.skuFound=="function"){l.skuFound(z)}}p.data("currentSku",z)}else{p.data("currentSku",null);if(typeof l.skuLost=="function"){l.skuLost()}}if(typeof l.selectionChanged=="function"){l.selectionChanged(v,w)}r=x});l.serializedSkuMap[s.attr(l.attrName)]?s.removeClass(l.disabledClass):s.addClass(l.disabledClass).removeClass(l.selectedClass)});if(l.default_sku){var q=key.replace(/^;|;$/gi,"");var o=q.split(";");m.each(function(){var s=b(this).attr(l.attrName);if(b.inArray(s,o)>-1){b(this).trigger("click")}})}})};function d(l){var k=[];for(var m in l){if(l[m]){k.push(l[m][0])}}return k}function h(m){for(var l in m){return l.split(";").length}}function j(m){var l=[];for(var k in m){l.push(k)}return l}function a(m){var n={},k,o,l;for(k in m){o=k.replace(/^;|;$/gi,"");l=o.split(";");l.sort(function(q,p){return parseInt(q.split(":")[0],10)>parseInt(p.split(":")[0],10)});o=l.join(";");n[o]=m[k]}return n}function c(l,n){var m={};for(key in l){var p=l[key];var o=key.split(";");if(!parseInt(p[n],10)){continue}var k=f(o);b(k).each(function(q,r){var s=g(r).join(";");e(s,p,m,n)});m[key]={stock:p[n]}}return m}function g(n){var m={},l,k,o;for(l=0;l<n.length;l++){k=n[l];o=k.replace(";");m[o]=k;n[l]=o}n.sort(function(q,p){return parseInt(q)-parseInt(p)});for(l=0;l<n.length;l++){n[l]=m[n[l]]}return n}function e(k,n,l,m){if(l[k]){l[k].stock+=parseInt(n[m])}else{l[k]={stock:parseInt(n[m])}}}function f(q){var m=this;var l,p,o,n;o=[];for(l=1;l<=q.length;l++){n=i(q,l);for(p=0;p<n.length;p++){o.push(n[p])}}return o}function i(s,n){var m=this;var r,o,q,p,l;if(n>s.length||n<=0){return[]}if(n==s.length){return[s]}if(n==1){q=[];for(r=0;r<s.length;r++){q.push([s[r]])}return q}q=[];for(r=0;r<s.length-n+1;r++){p=s.slice(r,r+1);l=i(s.slice(r+1),n-1);for(o=0;o<l.length;o++){q.push(p.concat(l[o]))}}return q}b.fn.sku.defaults={skuItem:".sku-item",selectedClass:"selected",disabledClass:"disabled",attrName:"data-value",stockKey:"stock",default_sku:undefined,skuChanged:function(k){},skuFound:function(k){},skuLost:function(){},selectionChanged:function(k,l){}}})(jQuery);